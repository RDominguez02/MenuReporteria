@model ResultadoReporteVentas

@{
    ViewData["Title"] = "Reporte de Ventas";
}

<link rel="stylesheet" href="~/css/reporte.css" />
<link rel="stylesheet" href="~/css/modal-factura.css" />

<div class="reporte-container">
    <!-- Header -->
    <div class="reporte-header">
        <div class="reporte-header-left">
            <div class="reporte-header-icon">💰</div>
            <h1>Reporte de Ventas</h1>
        </div>

        <!-- Resumen en el Header -->
        <div class="header-summary">
            <div class="header-summary-item">
                <div class="header-summary-label">Total Facturas</div>
                <div class="header-summary-value" id="totalFacturas">@(Model?.TotalFacturas ?? 0)</div>
            </div>
            <div class="header-summary-item">
                <div class="header-summary-label">Total Chasis</div>
                <div class="header-summary-value" id="totalChasis">@(Model?.TotalChasis ?? 0)</div>
            </div>
            <div class="header-summary-item">
                <div class="header-summary-label">Valor Total</div>
                <div class="header-summary-value" id="valorTotal">RD$ @((Model?.ValorTotal ?? 0).ToString("N2"))</div>
            </div>
        </div>

        <!-- Botones en el Header -->
        <div class="header-actions">
            <button type="button" class="btn-toggle-filters" onclick="toggleFiltros()">
                <span id="toggleIcon">🔽</span> Desplegar filtros
            </button>
            <button type="button" class="btn-action btn-aceptar" onclick="generarReporte()">
                ✓ Filtrar
            </button>
            <button type="button" class="btn-action btn-imprimir" onclick="imprimirReporte()">
                🖨️ Imprimir
            </button>
            <button type="button" class="btn-action btn-exportar" onclick="exportarReporte()">
                📥 Exportar
            </button>
            <button type="button" class="btn-action btn-retornar" onclick="window.location.href='@Url.Action("Index", "Home")'">
                ← Retornar
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <form id="filtrosForm" class="filters-section" method="post" action="@Url.Action("Generar", "Ventas")">
        <div class="filters-title">Filtros de Búsqueda</div>

        <div class="filters-grid">
            <!-- Fecha Desde -->
            <div class="filter-group">
                <label>Desde la Fecha</label>
                <input type="date" id="fechaDesde" name="fechaDesde" value="@Model?.Filtros?.FechaDesde.ToString("yyyy-MM-dd")" required>
                <small id="alertaFechas" class="alert-message" style="display:none;color:#d32f2f;">⚠️ La fecha desde no puede ser mayor que la fecha hasta</small>
            </div>

            <!-- Fecha Hasta -->
            <div class="filter-group">
                <label>Hasta la Fecha</label>
                <input type="date" id="fechaHasta" name="fechaHasta" value="@Model?.Filtros?.FechaHasta.ToString("yyyy-MM-dd")" required>
            </div>

            <!-- Cliente -->
            <div class="filter-group">
                <label>Cliente</label>
                <div class="cliente-input-group">
                    <input type="text" id="clienteInput" name="cliente" placeholder="Nombre del cliente..." value="@Model?.Filtros?.Cliente">
                    <button type="button" class="btn-modal-cliente" onclick="abrirModalClientes()">🔍</button>
                </div>
            </div>

            <!-- Vendedor -->
            <div class="filter-group">
                <label for="vendedorDisplay">Vendedor</label>
                <div class="cliente-input-group">
                    <input type="text" id="vendedorDisplay" readonly
                           placeholder="-- Todos --"
                           value="@(string.IsNullOrEmpty(Model?.Filtros?.Vendedor) ? "" : "Vendedores Seleccionados")">

                    <input type="hidden" id="vendedor" name="vendedor" value="@Model?.Filtros?.Vendedor">

                    <button type="button" class="btn-modal-cliente" onclick="abrirModalVendedores()">🔍</button>
                </div>
            </div>

            <!-- Valor Desde -->
            <div class="filter-group">
                <label>Valor Desde</label>
                <input type="number" id="valorDesde" name="valorDesde" step="0.01" placeholder="0.00" value="@Model?.Filtros?.ValorDesde">
                <small id="alertaValores" class="alert-message" style="display:none;color:#d32f2f;">⚠️ El valor desde no puede ser mayor que el valor hasta</small>
            </div>

            <!-- Valor Hasta -->
            <div class="filter-group">
                <label>Valor Hasta</label>
                <input type="number" id="valorHasta" name="valorHasta" step="0.01" placeholder="0.00" value="@Model?.Filtros?.ValorHasta">
            </div>

            <!-- NCF -->
            <div class="filter-group">
                <label>NCF</label>
                <input type="text" name="ncf" placeholder="Buscar por NCF..." value="@Model?.Filtros?.Ncf">
            </div>

            <!-- Factura Desde -->
            <div class="filter-group">
                <label>Factura</label>
                <input type="text" name="facturaDesde" placeholder="0" value="@Model?.Filtros?.FacturaDesde">
            </div>

            <!-- Caja -->
            <div class="filter-group">
                <label>Caja</label>
                <select name="caja">
                    <option value="">-- Todas --</option>
                    @if (Model?.Filtros?.CajasDisponibles != null)
                    {
                        @foreach (var caja in Model.Filtros.CajasDisponibles)
                        {
                            <option value="@caja" selected="@(Model.Filtros.Caja == caja ? "selected" : null)">@caja</option>
                        }
                    }
                </select>
            </div>

            <!-- Moneda -->
            <div class="filter-group">
                <label>Moneda</label>
                <select name="Moneda">
                    <option value="">-- Todas --</option>
                    @if (Model?.Filtros?.MonedasDisponibles != null)
                    {
                        @foreach (var moneda in Model.Filtros.MonedasDisponibles)
                        {
                            <option value="@moneda" selected="@(Model.Filtros.Moneda == moneda ? "selected" : null)">@moneda</option>
                        }
                    }
                </select>
            </div>

            <!-- Sucursal -->
            <div class="filter-group">
                <label>Sucursal</label>
                <select name="Sucursal">
                    <option value="">-- Todas --</option>
                    @if (Model?.Filtros?.SucursalesDisponibles != null)
                    {
                        @foreach (var sucursal in Model.Filtros.SucursalesDisponibles)
                        {
                            <option value="@sucursal" selected="@(Model.Filtros.Sucursal == sucursal ? "selected" : null)">@sucursal</option>
                        }
                    }
                </select>
            </div>

            <!-- Separador -->
            <div class="filter-separator"></div>

            <!-- Tipo de Factura -->
            <div class="report-type-group">
                <h4>Tipo de Factura</h4>
                <div class="report-type-options">
                    <label><input type="radio" name="tipoFactura" value="Contado"> Contado</label>
                    <label><input type="radio" name="tipoFactura" value="Crédito"> Crédito</label>
                    <label><input type="radio" name="tipoFactura" value="Todas" checked> Todas</label>
                </div>
            </div>

            <!-- Ordenado Por -->
            <div class="report-type-group">
                <h4>Ordenado Por</h4>
                <div class="report-type-options">
                    <label><input type="radio" name="ordenadoPor" value="FECHA_FACTURA" checked> FECHA + FACTURA</label>
                    <label><input type="radio" name="ordenadoPor" value="FACTURA"> FACTURA</label>
                </div>
            </div>

            <!-- Modo de Facturas -->
            <div class="report-type-group">
                <h4>Modo de Facturas</h4>
                <div class="report-type-options">
                    <label><input type="radio" name="modoFacturas" value="Mayor"> Al x Mayor</label>
                    <label><input type="radio" name="modoFacturas" value="Detalle"> Al Detalle</label>
                    <label><input type="radio" name="modoFacturas" value="Todas" checked> Todas</label>
                </div>
            </div>

            <!-- Opciones -->
            <div class="report-type-group">
                <h4>Opciones</h4>
                <div class="report-type-options">
                    <label><input type="radio" name="opciones" value="Normales">Normales / Venta Fichas / Inventario</label>
                    <label><input type="radio" name="opciones" value="SoloNCF">Facturas solo NCF / Cierre Mes</label>
                    <label><input type="radio" name="opciones" value="Editadas"> Facturas Editadas</label>
                    <label><input type="radio" name="opciones" value="Repuestos">Facturas de Repuestos</label>
                    <label><input type="radio" name="opciones" value="Placa">Facturas de Placa</label>
                    <label><input type="radio" name="opciones" value="Todas" checked>Todas</label>
                    <label><input type="radio" name="opciones" value="Archivo">Reporte para archivo</label>
                </div>
            </div>
        </div>
    </form>

    <!-- Modal Seleccionar Clientes -->
    <div id="modalClientes" class="modal-overlay" style="display:none;">
        <div class="modal-content modal-clientes">
            <div class="modal-header">
                <h2>Seleccionar Cliente</h2>
                <button type="button" class="btn-close" onclick="cerrarModalClientes()">✕</button>
            </div>
            <div class="modal-body">
                <div class="modal-buscar">
                    <input type="text"
                           id="buscarCliente"
                           placeholder="Escribe código o nombre (mín. 2 caracteres)..."
                           onkeyup="buscarClientesDebounce(this.value)"
                           onkeypress="buscarClientesEnter(event, this.value)">
                    <small style="color:#666;display:block;margin-top:5px;">
                        💡 Busca automáticamente mientras escribes o presiona Enter para búsqueda inmediata
                    </small>
                </div>
                <div id="listaClientes" class="lista-clientes">
                    <p style="text-align:center;color:#999;">Ingresa al menos 2 caracteres para buscar</p>
                </div>
                <div id="paginacionClientes" class="paginacion-clientes-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar" onclick="cerrarModalClientes()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Vendedores -->
    <div id="modalVendedores" class="modal-overlay" style="display:none;">
        <div class="modal-content modal-clientes" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Seleccionar Vendedores</h2>
                <button type="button" class="btn-close" onclick="cerrarModalVendedores()">✕</button>
            </div>
            <div class="modal-body">
                <div class="acciones-modal" style="margin-bottom: 10px; display: flex; gap: 10px;">
                    <button type="button" onclick="marcarTodosVendedores(true)" class="btn-action btn-imprimir" style="padding: 5px 10px; font-size: 12px;">Marcar Todos</button>
                    <button type="button" onclick="marcarTodosVendedores(false)" class="btn-action btn-retornar" style="padding: 5px 10px; font-size: 12px;">Desmarcar Todos</button>
                </div>

                <div id="listaVendedoresCheck" class="lista-clientes" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    @if (Model?.Filtros?.VendedoresDisponibles != null)
                    {
                        var seleccionados = (Model.Filtros.Vendedor ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries);
                        foreach (var vendedor in Model.Filtros.VendedoresDisponibles)
                        {
                            var isChecked = seleccionados.Contains(vendedor) ? "checked" : "";
                            <div class="vendedor-check-item" style="padding: 5px; border-bottom: 1px solid #eee;">
                                <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                                    <input type="checkbox" class="chk-vendedor" value="@vendedor" @isChecked style="margin-right: 10px; width: auto;">
                                    <span><strong>@vendedor</strong></span>
                                </label>
                            </div>
                        }
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-aplicar" onclick="aplicarFiltroVendedores()">Aplicar</button>
                <button type="button" class="btn-cancelar" onclick="cerrarModalVendedores()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Paginación -->
    <div class="pagination-container">
        <div class="pagination-info">
            <div class="records-per-page">
                <label>Registros por página:</label>
                <select id="recordsPerPage" onchange="cambiarRegistrosPorPagina()">
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="pagination-text">
                Mostrando <strong id="rangoInicio">0</strong> a <strong id="rangoFin">0</strong> de <strong id="totalRegistros">0</strong> registros
            </div>
        </div>
        <div class="pagination-controls" id="paginationControls">
        </div>
    </div>

    <!-- Tabla de Resultados -->
    <div id="tablaResultados" class="table-container">
        <table class="results-table">
            <thead>
                <tr>
                    <th>Ver Factura</th>
                    <th>Fecha</th>
                    <th>Factura</th>
                    <th>NCF</th>
                    <th>Codigo</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Monto Neto</th>
                    <th>Moneda</th>
                    <th>Tasa</th>
                    <th>Total Chasis</th>
                </tr>
            </thead>
            <tbody>
                @if (Model?.Ventas != null && Model.Ventas.Count > 0)
                {
                    @foreach (var venta in Model.Ventas)
                    {
                        <tr>
                            <td style="text-align: center;">
                                <button class="btn-ver-factura" onclick="abrirModalFactura('@venta.Factura')">
                                    👁️
                                </button>
                            </td>
                            <td>@venta.Fecha.ToString("dd/MM/yyyy")</td>
                            <td>@venta.Factura</td>
                            <td>@venta.Ncf</td>
                            <td>@venta.CodigoCliente</td>
                            <td>@venta.Cliente</td>
                            <td>@venta.Vendedor</td>
                            <td style="text-align: right;">@venta.MontoNeto.ToString("N2")</td>
                            <td>@venta.Moneda</td>
                            <td style="text-align: right;">@venta.Tasa.ToString("N2")</td>
                            <td style="text-align: right;">@venta.TotalChasis.ToString("N2")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="17" class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <div class="empty-state-text">No hay datos para mostrar</div>
                            <small>Ajusta los filtros y haz clic en "Aceptar" para cargar los datos</small>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Modal Factura -->
    <div id="modalFactura" class="modal-factura"></div>

@section Scripts {
        <script>
            // ==========================================
            // 1. VARIABLES GLOBALES UNIFICADAS
            // ==========================================
            let todosLosRegistros = [];
            let paginaActual = 1;
            let registrosPorPagina = 20;

            // Variables para Clientes (Unificadas aquí)
            let clientesDisponibles = [];
            let paginaClientesActual = 1;
            let totalClientesPaginas = 0;
            let filtroClienteActual = "";
            let timeoutBusqueda = null;

            // ==========================================
            // 2. INICIALIZACIÓN Y EVENTOS
            // ==========================================

            // Cargar datos iniciales si existen
            @if (Model?.Ventas != null && Model.Ventas.Count > 0)
            {
                    <text>
                    todosLosRegistros = @Html.Raw(Json.Serialize(Model.Ventas));
                    mostrarPagina(1);
                    </text>
            }

            // Listeners para validación de fechas
            document.getElementById('fechaDesde').addEventListener('change', validarFechas);
            document.getElementById('fechaHasta').addEventListener('change', validarFechas);

            // Listeners para validación de valores
            document.getElementById('valorDesde').addEventListener('change', validarValores);
            document.getElementById('valorHasta').addEventListener('change', validarValores);

            // Listeners para Inputs (Enter key)
            document.querySelectorAll('.filter-group input, .filter-group select').forEach(element => {
                element.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        generarReporte();
                    }
                });
            });

            // Listener para cerrar modales con clic fuera
            window.onclick = function(event) {
                const modal = document.getElementById('modalClientes');
                const modalFactura = document.getElementById('modalFactura'); // Si existe
                if (event.target === modal) {
                    cerrarModalClientes();
                }
                if (event.target === modalFactura) {
                    // Lógica para cerrar modal factura si es necesario
                }
            }

            // ==========================================
            // 3. FUNCIONES DE VALIDACIÓN
            // ==========================================

            function validarFechas() {
                const fechaDesde = new Date(document.getElementById('fechaDesde').value);
                const fechaHasta = new Date(document.getElementById('fechaHasta').value);
                const alerta = document.getElementById('alertaFechas');

                if (fechaDesde > fechaHasta && document.getElementById('fechaHasta').value) {
                    alerta.style.display = 'block';
                    return false;
                } else {
                    alerta.style.display = 'none';
                    return true;
                }
            }

            function validarValores() {
                const valorDesde = parseFloat(document.getElementById('valorDesde').value) || 0;
                const valorHasta = parseFloat(document.getElementById('valorHasta').value) || Infinity;
                const alerta = document.getElementById('alertaValores');

                if (valorDesde > valorHasta && document.getElementById('valorHasta').value) {
                    alerta.style.display = 'block';
                    return false;
                } else {
                    alerta.style.display = 'none';
                    return true;
                }
            }

            // ==========================================
            // 4. LÓGICA DEL MODAL DE CLIENTES (CORREGIDA)
            // ==========================================

            function abrirModalClientes() {
                const modal = document.getElementById('modalClientes');
                const input = document.getElementById('buscarCliente');

                modal.style.display = 'flex';
                input.value = "";

                // Pequeño timeout para asegurar el foco
                setTimeout(() => input.focus(), 100);

                limpiarListaClientes();
                paginaClientesActual = 1;
            }

            function cerrarModalClientes() {
                document.getElementById('modalClientes').style.display = 'none';
                limpiarListaClientes();
            }

            function limpiarListaClientes() {
                document.getElementById('listaClientes').innerHTML =
                    '<p style="text-align:center;color:#999;">Ingresa al menos 2 caracteres para buscar</p>';
                document.getElementById('paginacionClientes').innerHTML = '';
            }

            function buscarClientesDebounce(valor) {
                if (timeoutBusqueda) clearTimeout(timeoutBusqueda);

                if (valor.length < 2) {
                    limpiarListaClientes();
                    return;
                }

                document.getElementById('listaClientes').innerHTML =
                    '<p style="text-align:center;color:#999;">🔍 Buscando...</p>';

                timeoutBusqueda = setTimeout(() => {
                    cargarClientes(valor, 1);
                }, 500);
            }

            function buscarClientesEnter(event, valor) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (timeoutBusqueda) clearTimeout(timeoutBusqueda);

                    if (valor.length < 2) {
                        alert('⚠️ Ingresa al menos 2 caracteres para buscar');
                        return;
                    }

                    document.getElementById('listaClientes').innerHTML =
                        '<p style="text-align:center;color:#999;">🔍 Buscando...</p>';
                    cargarClientes(valor, 1);
                }
            }

            function cargarClientes(filtro, pagina) {
                filtroClienteActual = filtro;
                paginaClientesActual = pagina;

                // Aseguramos que la URL sea correcta
                const url = `@Url.Action("ObtenerClientes", "Ventas")?filtro=${encodeURIComponent(filtro)}&pagina=${pagina}&registrosPorPagina=15`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Validamos la respuesta
                        clientesDisponibles = data.clientes || [];
                        totalClientesPaginas = data.totalPaginas || 0;

                        if (clientesDisponibles.length > 0) {
                            mostrarClientes(clientesDisponibles);
                            mostrarPaginacionClientes(data.total, pagina, totalClientesPaginas);
                        } else {
                            const mensaje = data.mensaje || 'No se encontraron clientes';
                            document.getElementById('listaClientes').innerHTML =
                                `<p style="text-align:center;color:#999;">❌ ${mensaje}</p>`;
                            document.getElementById('paginacionClientes').innerHTML = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('listaClientes').innerHTML =
                            '<p style="text-align:center;color:#d32f2f;">⚠️ Error de conexión al buscar clientes</p>';
                    });
            }

            function mostrarClientes(clientes) {
                const lista = document.getElementById('listaClientes');
                let html = '';

                clientes.forEach(cliente => {
                    // Escapar comillas simples para evitar errores en el onclick
                    const codigo = String(cliente.codigo).replace(/'/g, "\\'");
                    const nombre = String(cliente.nombre).replace(/'/g, "\\'");

                    html += `<div class="cliente-item" onclick="seleccionarCliente('${codigo}', '${nombre}')">
                        <div class="cliente-codigo">${cliente.codigo}</div>
                        <div class="cliente-nombre">${cliente.nombre}</div>
                    </div>`;
                });
                lista.innerHTML = html;
            }

            function mostrarPaginacionClientes(total, paginaActual, totalPaginas) {
                const contenedor = document.getElementById('paginacionClientes');
                if (totalPaginas <= 1) {
                    contenedor.innerHTML = '';
                    return;
                }

                let html = `<div class="paginacion-clientes">
                    <small>Página ${paginaActual} de ${totalPaginas} (${total} clientes)</small>
                    <div class="paginacion-botones">`;

                if (paginaActual > 1) {
                    html += `<button class="pag-btn" onclick="cargarClientes('${filtroClienteActual}', ${paginaActual - 1})">←</button>`;
                }

                // Lógica simple de paginación para no saturar botones
                for (let i = Math.max(1, paginaActual - 2); i <= Math.min(totalPaginas, paginaActual + 2); i++) {
                    if (i === paginaActual) {
                        html += `<button class="pag-btn active">${i}</button>`;
                    } else {
                        html += `<button class="pag-btn" onclick="cargarClientes('${filtroClienteActual}', ${i})">${i}</button>`;
                    }
                }

                if (paginaActual < totalPaginas) {
                    html += `<button class="pag-btn" onclick="cargarClientes('${filtroClienteActual}', ${paginaActual + 1})">→</button>`;
                }

                html += `</div></div>`;
                contenedor.innerHTML = html;
            }

            function seleccionarCliente(codigo, nombre) {
                document.getElementById('clienteInput').value = nombre;
                cerrarModalClientes();
            }

            // ==========================================
            // 5. LÓGICA GENERAL (FILTROS, REPORTE, PDF)
            // ==========================================

            function toggleFiltros() {
                const filtros = document.getElementById('filtrosForm');
                const icon = document.getElementById('toggleIcon');

                if (filtros.classList.contains('hidden')) {
                    filtros.classList.remove('hidden'); // Clase CSS debe estar definida o usar style.display
                    // Si usas style inline en el HTML original:
                    if(filtros.style.display === 'none') filtros.style.display = 'block';
                    icon.textContent = '🔽';
                } else {
                    filtros.classList.add('hidden');
                     // Si usas style inline:
                    if(filtros.style.display !== 'none') filtros.style.display = 'none';
                    icon.textContent = '▶️';
                }
            }

            function generarReporte() {
                if (!validarFechas()) { alert('⚠️ Fecha Inválida'); return; }
                if (!validarValores()) { alert('⚠️ Valor Inválido'); return; }

                const form = document.getElementById('filtrosForm');
                const formData = new FormData(form);

                // Ocultar filtros al buscar para dar espacio
                const filtros = document.getElementById('filtrosForm');
                filtros.classList.add('hidden');

                paginaActual = 1;
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('tablaResultados').style.display = 'none';

                fetch('@Url.Action("Generar", "Ventas")', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        todosLosRegistros = data.data.ventas || [];
                        actualizarResumen(data);
                        mostrarPagina(1);
                    } else {
                        alert('Error: ' + data.message);
                    }
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('tablaResultados').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar los datos');
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('tablaResultados').style.display = 'block';
                });
            }

            function cambiarRegistrosPorPagina() {
                registrosPorPagina = parseInt(document.getElementById('recordsPerPage').value);
                paginaActual = 1;
                mostrarPagina(1);
            }

            function mostrarPagina(pagina) {
                paginaActual = pagina;
                const inicio = (pagina - 1) * registrosPorPagina;
                const fin = inicio + registrosPorPagina;
                const registrosPagina = todosLosRegistros.slice(inicio, fin);

                actualizarTabla(registrosPagina);
                actualizarInfoPaginacion(inicio, fin);
                generarBotonesPaginacion();
            }

            function actualizarInfoPaginacion(inicio, fin) {
                const total = todosLosRegistros.length;
                document.getElementById('rangoInicio').textContent = total > 0 ? inicio + 1 : 0;
                document.getElementById('rangoFin').textContent = Math.min(fin, total);
                document.getElementById('totalRegistros').textContent = total;
            }

            function generarBotonesPaginacion() {
                const totalPaginas = Math.ceil(todosLosRegistros.length / registrosPorPagina);
                const contenedor = document.getElementById('paginationControls');
                let html = '';

                html += `<button class="pagination-btn" onclick="mostrarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>← Anterior</button>`;

                // Lógica simplificada de botones
                let inicioPagina = Math.max(1, paginaActual - 2);
                let finPagina = Math.min(totalPaginas, paginaActual + 2);

                if (inicioPagina > 1) html += `<button class="pagination-btn" onclick="mostrarPagina(1)">1</button><span>...</span>`;

                for (let i = inicioPagina; i <= finPagina; i++) {
                    html += `<button class="pagination-btn ${i === paginaActual ? 'active' : ''}" onclick="mostrarPagina(${i})">${i}</button>`;
                }

                if (finPagina < totalPaginas) html += `<span>...</span><button class="pagination-btn" onclick="mostrarPagina(${totalPaginas})">${totalPaginas}</button>`;

                html += `<button class="pagination-btn" onclick="mostrarPagina(${paginaActual + 1})" ${paginaActual >= totalPaginas ? 'disabled' : ''}>Siguiente →</button>`;

                contenedor.innerHTML = html;
            }

            function actualizarTabla(ventas) {
                const tbody = document.querySelector('.results-table tbody');
                if (ventas && ventas.length > 0) {
                    let html = '';
                    ventas.forEach(venta => {
                        const fecha = new Date(venta.fecha);
                        // Formateo básico de fecha
                        const fechaFormateada = ('0' + fecha.getDate()).slice(-2) + '/' + ('0' + (fecha.getMonth() + 1)).slice(-2) + '/' + fecha.getFullYear();

                        html += `<tr>
                            <td style="text-align:center;">
                                <button class="btn-ver-factura" onclick="abrirModalFactura('${venta.factura}')">👁️</button>
                            </td>
                            <td>${fechaFormateada}</td>
                            <td>${venta.factura}</td>
                            <td>${venta.ncf || ''}</td>
                            <td>${venta.codigoCliente || ''}</td>
                            <td>${venta.cliente}</td>
                            <td>${venta.vendedor || ''}</td>
                            <td style="text-align: right;">${parseFloat(venta.montoNeto).toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                            <td>${venta.moneda}</td>
                            <td style="text-align: right;">${parseFloat(venta.tasa).toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                            <td style="text-align: right;">${parseFloat(venta.totalChasis).toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = `<tr><td colspan="17" class="empty-state"><div class="empty-state-icon">📊</div><div class="empty-state-text">No se encontraron resultados</div></td></tr>`;
                }
            }

            function actualizarResumen(data) {
                document.getElementById('totalFacturas').textContent = data.totalFacturas;
                document.getElementById('totalChasis').textContent = data.totalChasis;
                document.getElementById('valorTotal').textContent = 'RD$ ' + data.valorTotal;
            }

            function imprimirReporte() {
                if (todosLosRegistros.length === 0) {
                    alert('⚠️ No hay datos cargados para imprimir.'); return;
                }
                const formData = new FormData(document.getElementById('filtrosForm'));
                document.getElementById('loadingSpinner').style.display = 'block';

                fetch('@Url.Action("GenerarPDF", "Ventas")', { method: 'POST', body: formData })
                .then(response => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    if (response.ok) return response.blob();
                    throw new Error('Error al generar el PDF');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ReporteVentas_${new Date().toISOString().slice(0, 10)}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    alert('❌ Error: ' + error.message);
                });
            }

            function exportarReporte() {
                if (todosLosRegistros.length === 0) {
                    alert('⚠️ No hay datos cargados para exportar.'); return;
                }
                const formData = new FormData(document.getElementById('filtrosForm'));
                document.getElementById('loadingSpinner').style.display = 'block';

                fetch('@Url.Action("ExportarExcel", "Ventas")', { method: 'POST', body: formData })
                .then(response => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    if (response.ok) return response.blob();
                    throw new Error('Error al generar el Excel');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ReporteVentas_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    alert('❌ Error: ' + error.message);
                });
            }

                     // --- Lógica Modal Vendedores ---
                    function abrirModalVendedores() {
                        document.getElementById('modalVendedores').style.display = 'flex';
                    }

                    function cerrarModalVendedores() {
                        document.getElementById('modalVendedores').style.display = 'none';
                    }

                    function marcarTodosVendedores(estado) {
                        const checks = document.querySelectorAll('.chk-vendedor');
                        checks.forEach(chk => chk.checked = estado);
                    }

                    function aplicarFiltroVendedores() {
                        const checks = document.querySelectorAll('.chk-vendedor:checked');
                        const codigos = Array.from(checks).map(c => c.value);

                        // Actualizar input oculto (para el backend)
                        document.getElementById('vendedor').value = codigos.join(',');

                        // Actualizar visualización
                        const display = document.getElementById('vendedorDisplay');
                        if (codigos.length === 0) {
                            display.value = "";
                            display.placeholder = "-- Todos --";
                        } else if (codigos.length === 1) {
                            display.value = codigos[0]; // Muestra el código si es solo uno
                        } else {
                            display.value = `${codigos.length} Vendedores seleccionados`;
                        }

                        cerrarModalVendedores();
                    }

                    // Ejecutar al cargar para mostrar el texto correcto si ya hay filtro aplicado
                    window.addEventListener('load', function() {
                        const valorActual = document.getElementById('vendedor').value;
                        if (valorActual) {
                            const cantidad = valorActual.split(',').length;
                            const display = document.getElementById('vendedorDisplay');
                            if (cantidad === 1) display.value = valorActual;
                            else display.value = `${cantidad} Vendedores seleccionados`;
                        }
                    });

                    // Cerrar modal al hacer clic fuera
                    window.onclick = function(event) {
                        const modal = document.getElementById('modalVendedores');
                        if (event.target === modal) {
                            cerrarModalVendedores();
                        }
                    }
        </script>
        <script src="~/js/modal-factura.js"></script>
}
