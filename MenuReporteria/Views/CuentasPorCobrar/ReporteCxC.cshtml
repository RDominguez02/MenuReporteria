@model ResultadoCxC

@{
    ViewData["Title"] = "Reporte de Cuentas por Cobrar";
}

<link rel="stylesheet" href="~/css/cxc.css" />
<link rel="stylesheet" href="~/css/modal-factura.css" />

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relación Cuentas x Cobrar - Estado x Cliente</title>
</head>
<body>
    <div class="reporte-container">
        <!-- Header -->
        <div class="reporte-header">
            <div class="reporte-header-left">
                <div class="reporte-header-icon">📊</div>
                <h1>Relación Cuentas x Cobrar</h1>
            </div>

            <!-- Resumen en el Header -->
            <div class="header-summary">
                <div class="header-summary-item">
                    <div class="header-summary-label">Total Registros</div>
                    <div class="header-summary-value" id="totalRegistros">@(Model?.TotalFacturas ?? 0)</div>
                </div>
                <div class="header-summary-item">
                    <div class="header-summary-label">Total Monto</div>
                    <div class="header-summary-value" id="totalMonto">RD$ @((Model?.ValorTotal ?? 0).ToString("N2"))</div>
                </div>
            </div>

            <!-- Botones en el Header -->
            <div class="header-actions">
                <button type="button" class="btn-toggle-filters" onclick="toggleFiltros()">
                    <span id="toggleIcon">🔽</span> Desplegar filtros
                </button>
                <button type="button" class="btn-action btn-aceptar" onclick="generarReporte()">
                    ✓ Filtrar
                </button>
                <button type="button" class="btn-action btn-imprimir" onclick="imprimirReporte()">
                    🖨️ Imprimir
                </button>
                <button type="button" class="btn-action btn-exportar" onclick="exportarReporte()">
                    📥 Exportar
                </button>
                <button type="button" class="btn-action btn-retornar" onclick="window.location.href='@Url.Action("Index", "Home")'">
                    ← Retornar
                </button>
            </div>
        </div>

       <!-- Filtros -->
<form id="filtrosForm" class="filters-section" method="post" action="@Url.Action("Generar", "CuentasPorCobrar")">
    @Html.AntiForgeryToken()
    <div class="filters-title">Criterios de Búsqueda</div>
    <div class="filters-grid">
        <!-- Fecha Desde -->
            <div class="filter-group">
                <label for="fechaDesde">Desde la Fecha de Corte</label>
                <input type="date" id="fechaDesde" name="fechaDesde"
                        value="@(Model?.Filtros?.FechaDesde.HasValue == true ? Model.Filtros.FechaDesde.Value.ToString("yyyy-MM-dd") : "")">
                <small id="alertaFechas" class="alert-message" style="display:none;color:#d32f2f;">⚠️ La fecha desde no puede ser mayor que la fecha hasta</small>
            </div>

        <!-- Fecha Hasta -->
        <div class="filter-group">
            <label for="fechaHasta">Hasta la Fecha De Corte</label>
            <input type="date" id="fechaHasta" name="fechaHasta" value="@Model?.Filtros?.FechaHasta?.ToString("yyyy-MM-dd")" required>
        </div>

        <!-- Zona -->
        <div class="filter-group">
            <label for="zona">Para la Zona</label>
            <select id="zona" name="zona">
                <option value="">-- Todas --</option>
                @if (Model?.Filtros?.ZonasDisponibles != null)
                {
                    foreach (var zona in Model.Filtros.ZonasDisponibles)
                    {
                        <option value="@zona.Valor" selected="@(string.Equals(Model?.Filtros?.Zona, zona.Valor, System.StringComparison.OrdinalIgnoreCase))">
                            @zona.Texto
                        </option>
                    }
                }
            </select>
        </div>

        <!-- Cliente con Modal de Búsqueda -->
        <div class="filter-group">
            <label for="clienteInput">Para el Cliente</label>
            <div class="cliente-input-group">
                <input type="text" id="clienteInput" name="cliente" placeholder="Nombre del cliente..." value="@Model?.Filtros?.Cliente">
                <button type="button" class="btn-modal-cliente" onclick="abrirModalClientesCxC()">📋 Lista</button>
            </div>
        </div>

        <!-- Vendedor -->
                <div class="filter-group">
                    <label for="vendedorDisplay">Para el Vendedor</label>
                    <div class="cliente-input-group">
                        <input type="text" id="vendedorDisplay" readonly
                               placeholder="-- Todos --"
                               value="@(string.IsNullOrEmpty(Model?.Filtros?.Vendedor) ? "" : "Vendedores Seleccionados")">

                        <input type="hidden" id="vendedor" name="vendedor" value="@Model?.Filtros?.Vendedor">

                        <button type="button" class="btn-modal-cliente" onclick="abrirModalVendedores()">📋 Lista</button>
                    </div>
                </div>

        <!-- Factura Desde -->
        <div class="filter-group">
            <label for="factura">Desde la Factura</label>
            <input type="text" id="factura" name="factura" placeholder="Número de factura" value="@Model?.Filtros?.FacturaDesde">
        </div>

        <!-- Factura Hasta -->
        <div class="filter-group">
            <label for="facturaHasta">Hasta la Factura</label>
            <input type="text" id="facturaHasta" name="facturaHasta" placeholder="Número de factura" value="@Model?.Filtros?.FacturaHasta">
        </div>

        <!-- Cuota Desde -->
        <div class="filter-group">
            <label for="cuotaDesde">Desde la Cuota</label>
            <input type="number" id="cuotaDesde" name="cuotaDesde" placeholder="Número de cuota" value="@(Model?.Filtros?.CuotaDesde?.ToString() ?? string.Empty)">
        </div>

        <!-- Cuota Hasta -->
        <div class="filter-group">
            <label for="cuotaHasta">Hasta la Cuota</label>
            <input type="number" id="cuotaHasta" name="cuotaHasta" placeholder="Número de cuota" value="@(Model?.Filtros?.CuotaHasta?.ToString() ?? string.Empty)">
        </div>

        <!-- Moneda -->
        <div class="filter-group">
            <label for="moneda">Para la Moneda</label>
            <select id="moneda" name="moneda">
                <option value="">-- Todas --</option>
                @if (Model?.Filtros?.MonedasDisponibles != null)
                {
                    foreach (var moneda in Model.Filtros.MonedasDisponibles)
                    {
                        <option value="@moneda.Valor" selected="@(string.Equals(Model?.Filtros?.Moneda, moneda.Valor, System.StringComparison.OrdinalIgnoreCase))">
                            @moneda.Texto
                        </option>
                    }
                }
            </select>
        </div>

        <!-- Separador -->
        <div class="filter-separator"></div>

        <!-- Orden de Moneda -->
        <div class="report-type-group">
            <h4>Orden de Moneda</h4>
            <div class="report-type-options">
                <label>
                    <input type="radio" name="ordenMoneda" value="opcion1" checked>
                    Orden de Moneda + Fecha + Factura
                </label>
                <label>
                    <input type="radio" name="ordenMoneda" value="opcion2">
                    Orden de Moneda + Facturas + Fecha
                </label>
            </div>
        </div>
    </div>
</form>

    <!-- Modal Seleccionar Clientes CxC -->
    <div id="modalClientesCxC" class="modal-overlay" style="display:none;">
        <div class="modal-content modal-clientes">
            <div class="modal-header">
                <h2>Seleccionar Cliente</h2>
                <button type="button" class="btn-close" onclick="cerrarModalClientesCxC()">✕</button>
            </div>
            <div class="modal-body">
                <div class="modal-buscar">
                    <input 
                        type="text" 
                        id="buscarClienteCxC" 
                        placeholder="Escribe código o nombre (mín. 2 caracteres)..."
                        onkeyup="buscarClientesCxCDebounce(this.value)"
                        onkeypress="buscarClientesCxCEnter(event, this.value)"
                    >
                    <small style="color:#666;display:block;margin-top:5px;">
                        💡 Busca automáticamente mientras escribes o presiona Enter para búsqueda inmediata
                    </small>
                </div>
                <div id="listaClientesCxC" class="lista-clientes">
                    <p style="text-align:center;color:#999;">Ingresa al menos 2 caracteres para buscar</p>
                </div>
                <div id="paginacionClientesCxC" class="paginacion-clientes-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancelar" onclick="cerrarModalClientesCxC()">Cancelar</button>
            </div>
        </div>
    </div>

        <div id="modalVendedores" class="modal-overlay" style="display:none;">
            <div class="modal-content modal-clientes" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Seleccionar Vendedores</h2>
                    <button type="button" class="btn-close" onclick="cerrarModalVendedores()">✕</button>
                </div>
                <div class="modal-body">
                    <div class="acciones-modal" style="margin-bottom: 10px; display: flex; gap: 10px;">
                        <button type="button" onclick="marcarTodosVendedores(true)" class="btn-action btn-imprimir" style="padding: 5px 10px; font-size: 12px;">Marcar Todos</button>
                        <button type="button" onclick="marcarTodosVendedores(false)" class="btn-action btn-retornar" style="padding: 5px 10px; font-size: 12px;">Desmarcar Todos</button>
                    </div>

                    <div id="listaVendedoresCheck" class="lista-clientes" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                        @if (Model?.Filtros?.VendedoresDisponibles != null)
                        {
                            var seleccionados = (Model.Filtros.Vendedor ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries);
                            foreach (var vendedor in Model.Filtros.VendedoresDisponibles)
                            {
                                var isChecked = seleccionados.Contains(vendedor.Valor) ? "checked" : "";
                                <div class="vendedor-check-item" style="padding: 5px; border-bottom: 1px solid #eee;">
                                    <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                                        <input type="checkbox" class="chk-vendedor" value="@vendedor.Valor" @isChecked style="margin-right: 10px; width: auto;">
                                        <span><strong>@vendedor.Valor</strong> - @vendedor.Texto</span>
                                    </label>
                                </div>
                            }
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancelar" onclick="cerrarModalVendedores()">Cancelar</button>
                    <button type="button" class="btn-aceptar" onclick="aplicarFiltroVendedores()">Aplicar Selección</button>
                </div>
            </div>
        </div>

        <!-- Modal Relación de Pagos (NUEVO) -->
        <div id="modalRelacionPagos" class="modal-overlay" style="display:none; z-index: 1060;">
            <div class="modal-content" style="max-width: 800px; width: 90%;">
                <div class="modal-header">
                    <h2 id="tituloModalPagos">Relación de Ingresos</h2>
                    <button type="button" class="btn-close" onclick="cerrarModalRelacionPagos()">✕</button>
                </div>
                <div class="modal-body">
                    <div id="loadingPagos" style="text-align:center; padding: 20px;">
                        <div class="spinner"></div>
                        <p>Cargando pagos...</p>
                    </div>
                    <div id="contenidoPagos" style="display:none; max-height: 500px; overflow-y: auto;">
                        <table class="modal-pagos-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Documento</th>
                                    <th>Observación</th>
                                    <th>Moneda</th>
                                    <th class="monto-col">Monto</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPagosBody">
                                <!-- Se llena con JS -->
                            </tbody>
                            <tfoot id="tablaPagosFooter">
                                <!-- Total -->
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancelar" onclick="cerrarModalRelacionPagos()">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Cargando datos...</p>
        </div>

        <!-- Paginación Superior -->
        <div class="pagination-container">
            <div class="pagination-info">
                <div class="records-per-page">
                    <label for="recordsPerPage">Registros por página:</label>
                    <select id="recordsPerPage" name="recordsPerPage" onchange="cambiarRegistrosPorPagina()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="pagination-text">
                    Mostrando <strong id="rangoInicio">0</strong> a <strong id="rangoFin">0</strong> de <strong id="totalRegistrosPagina">0</strong> registros
                </div>
            </div>
            <div class="pagination-controls" id="paginationControls">
                <!-- Los botones de paginación se generarán dinámicamente -->
            </div>
        </div>

        <!-- Tabla de Resultados -->
        <div id="tablaResultados" class="table-container">
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Nombre / Dirección</th>
                        <th>Fecha Factura</th>
                        <th>Factura</th>
                        <th>Fecha Cuota</th>
                        <th>Días Vencimiento</th>
                        <th>Nro Cuota</th>
                        <th>Moneda</th>
                        <th>Zona</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.Items != null && Model.Items.Count > 0)
                    {
                        @foreach (var CXC in Model.Items)
                        {
                            <tr>
                                <td>
                                    <div>@CXC.NombreCliente</div>
                                    <small>@CXC.Direccion</small>
                                </td>
                                <td>@CXC.FechaFactura.ToString("dd-MM-yyyy")</td>
                                <td>@CXC.Factura</td>
                                <td>@CXC.FechaFactura.ToString("dd-MM-yyyy")</td>
                                <td>@CXC.DiasVencimiento</td>
                                <td>@CXC.Cuota</td>
                                <td>@CXC.Moneda</td>
                                <td>@CXC.Zona</td>
                                <td style="text-align: right;">@CXC.TotalR.ToString("N2")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">📊</div>
                                <div class="empty-state-text">No hay datos para mostrar</div>
                                <small>Ajusta los filtros y haz clic en "Filtrar" para cargar los datos</small>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div id="resumenMonedasContainer" class="resumen-monedas-section" style="display:none;">
        </div>

        <!-- Paginación Inferior -->
        <div class="pagination-container">
            <div class="pagination-info">
                <div class="pagination-text">
                    Página <strong id="paginaActualInfo">1</strong> de <strong id="totalPaginasInfo">1</strong>
                </div>
            </div>
            <div class="pagination-controls" id="paginationControlsBottom">
                <!-- Los botones de paginación se generarán dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        // Variables de paginación
        let todosLosRegistros = [];
        let gruposClientes = []; // Nuevo: almacenar grupos
        let paginaActual = 1;
        let registrosPorPagina = 10; // Ahora son grupos, no registros

        // Toggle filtros
        function toggleFiltros() {
            const filtros = document.getElementById('filtrosForm');
            const icon = document.getElementById('toggleIcon');

            if (filtros.classList.contains('hidden')) {
                filtros.classList.remove('hidden');
                icon.textContent = '🔽';
            } else {
                filtros.classList.add('hidden');
                icon.textContent = '▶️';
            }
        }

        // Generar reporte
        function generarReporte() {
            const form = document.getElementById('filtrosForm');
            const formData = new FormData(form);

            // Ocultar filtros después de generar
            const filtros = document.getElementById('filtrosForm');
            const icon = document.getElementById('toggleIcon');
            filtros.classList.add('hidden');
            icon.textContent = '▶️';

            // Reiniciar paginación
            paginaActual = 1;

            // Mostrar spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('tablaResultados').style.display = 'none';

            // Enviar formulario
            fetch('@Url.Action("Generar", "CuentasPorCobrar")', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Guardar todos los registros
                    todosLosRegistros = data.data.cuentas || [];

                    // Agrupar por cliente
                    agruparPorCliente();

                    actualizarResumen(data);
                    mostrarPagina(1);
                } else {
                    alert('Error: ' + data.message);
                }

                // Ocultar spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('tablaResultados').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los datos');
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('tablaResultados').style.display = 'block';
            });
        }

        // Agrupar registros por cliente
                       function agruparPorCliente() {
            const grupos = {};

            // Ordenamos por: 1. Nombre Cliente, 2. Moneda, 3. Fecha
            const ordenados = [...todosLosRegistros].sort((a, b) => {
                // Ordenar por Nombre
                const na = (a.nombreCliente || a.NombreCliente || '').localeCompare(b.nombreCliente || b.NombreCliente || '', 'es-DO');
                if (na !== 0) return na;

                // Si es el mismo nombre, ordenar por Moneda
                const ma = (a.moneda || a.Moneda || '').localeCompare(b.moneda || b.Moneda || '');
                if (ma !== 0) return ma;

                // Si es la misma moneda, ordenar por fecha
                const dateA = a.fechaFactura ? new Date(a.fechaFactura) : (a.FechaFactura ? new Date(a.FechaFactura) : new Date(0));
                const dateB = b.fechaFactura ? new Date(b.fechaFactura) : (b.FechaFactura ? new Date(b.FechaFactura) : new Date(0));
                return dateA.getTime() - dateB.getTime();
            });

            for (const r of ordenados) {
                const nombre = r.nombreCliente || r.NombreCliente || '(Sin nombre)';
                const moneda = r.moneda || r.Moneda || '???';

                // --- CAMBIO: La clave ahora incluye la moneda para separar grupos ---
                const key = `${nombre}|${moneda}`;

                if (!grupos[key]) grupos[key] = [];
                grupos[key].push(r);
            }

            gruposClientes = Object.keys(grupos).map(key => {
                const items = grupos[key];
                const primerItem = items[0];

                // Recuperamos datos del primer item
                const nombre = primerItem.nombreCliente || primerItem.NombreCliente || '(Sin nombre)';
                const moneda = primerItem.moneda || primerItem.Moneda || '';
                const codigo = primerItem.codigoCliente || primerItem.CodigoCliente || '';

                const itemConDir = items.find(x => x.direccion || x.Direccion);
                const direccion = itemConDir ? (itemConDir.direccion || itemConDir.Direccion) : '';

                return {
                    nombre: nombre,
                    moneda: moneda, // Guardamos la moneda a nivel de grupo
                    direccion: direccion,
                    codigoCliente: codigo,
                    items: items
                };
            });
        }

        // Cambiar registros por página (ahora grupos)
        function cambiarRegistrosPorPagina() {
            registrosPorPagina = parseInt(document.getElementById('recordsPerPage').value);
            paginaActual = 1;
            mostrarPagina(1);
        }

        // Mostrar página específica
        function mostrarPagina(pagina) {
            paginaActual = pagina;

            const inicio = (pagina - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const gruposPagina = gruposClientes.slice(inicio, fin);

            actualizarTabla(gruposPagina);
            actualizarInfoPaginacion(inicio, fin);
            generarBotonesPaginacion();
        }

        // Actualizar información de paginación
        function actualizarInfoPaginacion(inicio, fin) {
            const total = gruposClientes.length;
            document.getElementById('rangoInicio').textContent = total > 0 ? inicio + 1 : 0;
            document.getElementById('rangoFin').textContent = Math.min(fin, total);
            document.getElementById('totalRegistrosPagina').textContent = total;

            const totalPaginas = Math.ceil(total / registrosPorPagina);
            document.getElementById('paginaActualInfo').textContent = paginaActual;
            document.getElementById('totalPaginasInfo').textContent = totalPaginas || 1;
        }

        // Generar botones de paginación
        function generarBotonesPaginacion() {
            const totalPaginas = Math.ceil(gruposClientes.length / registrosPorPagina);
            const contenedorTop = document.getElementById('paginationControls');
            const contenedorBottom = document.getElementById('paginationControlsBottom');

            let html = '';

            // Botón anterior
            html += `<button class="pagination-btn" onclick="mostrarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>
                ← Anterior
            </button>`;

            // Lógica para mostrar números de página
            const maxBotones = 5;
            let inicioPagina = Math.max(1, paginaActual - 2);
            let finPagina = Math.min(totalPaginas, inicioPagina + maxBotones - 1);

            if (finPagina - inicioPagina < maxBotones - 1) {
                inicioPagina = Math.max(1, finPagina - maxBotones + 1);
            }

            // Primera página
            if (inicioPagina > 1) {
                html += `<button class="pagination-btn" onclick="mostrarPagina(1)">1</button>`;
                if (inicioPagina > 2) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            // Páginas numeradas
            for (let i = inicioPagina; i <= finPagina; i++) {
                html += `<button class="pagination-btn ${i === paginaActual ? 'active' : ''}" onclick="mostrarPagina(${i})">${i}</button>`;
            }

            // Última página
            if (finPagina < totalPaginas) {
                if (finPagina < totalPaginas - 1) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="mostrarPagina(${totalPaginas})">${totalPaginas}</button>`;
            }

            // Botón siguiente
            html += `<button class="pagination-btn" onclick="mostrarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas || totalPaginas === 0 ? 'disabled' : ''}>
                Siguiente →
            </button>`;

            contenedorTop.innerHTML = html;
            contenedorBottom.innerHTML = html;
        }

        // Actualizar tabla con datos AGRUPADOS
                   function actualizarTabla(grupos) {
            const tbody = document.querySelector('.results-table tbody');

            if (grupos && grupos.length > 0) {
                let html = '';

                grupos.forEach(grupo => {
                    const nombre = grupo.nombre;
                    const monedaGrupo = grupo.moneda;
                    const direccion = grupo.direccion;
                    const codigoCliente = grupo.codigoCliente;
                    const items = grupo.items;

                    // 1. Header del Grupo
                    html += `
                        <tr class="group-header">
                            <td colspan="9" style="background:#f4f6f8; padding: 8px 15px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <strong style="font-size:22px">${nombre}</strong>
                                        <span class="badge-moneda" style="background:#00bcd4; color:white; padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:5px;">${monedaGrupo}</span>
                                        ${direccion ? `<span style="color:#666; font-weight:normal;"> - ${direccion}</span>` : ''}
                                    </div>
                                    <button type="button" class="btn-relacion-pago"
                                            onclick="abrirModalRelacionPagos('${codigoCliente}', '${nombre.replace(/'/g, "\\'")}')">
                                        💰 Relación Pagos
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;

                    // 2. Items
                    let subtotal = 0;
                    items.forEach(registro => {
                        const fecha = registro.fechaFactura ? new Date(registro.fechaFactura) : null;
                        const fechaFormateada = fecha ? fecha.toLocaleDateString('es-DO') : '';
                        const balance = parseFloat(registro.totalR || 0);
                        subtotal += isNaN(balance) ? 0 : balance;

                        html += `
                            <tr>
                                <td>
                                    <button class="btn-ver-factura" onclick="abrirModalFacturaCxC('${registro.factura}', '${registro.codigoCliente || ''}')">👁️ Ver</button>
                                </td>
                                <td style="font-weight:600;">${fechaFormateada}</td>
                                <td style="font-weight:600;">${registro.factura || ''}</td>
                                <td style="font-weight:600;">${fechaFormateada}</td>
                                <td style="font-weight:600;">${registro.diasVencimiento ?? 0}</td>
                                <td style="font-weight:600;">${registro.cuota || ''}</td>
                                <td style="font-weight:600;">${registro.moneda || ''}</td>
                                <td style="font-weight:600;">${registro.zona || ''}</td>
                                <td style="text-align: right;font-weight:600;">${(balance).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            </tr>
                        `;
                    });

                    // 3. Subtotal con subrayado azul tenue (CAMBIO SOLICITADO)
                     html += `
                            <tr class="group-subtotal-resaltado" style="background-color: #1e3c72 ;">
                            <td colspan="8" style="text-align:left; font-weight:700; color:#FFF; background-color: #1e3c72  !important;">
                                Subtotal ${nombre}:
                            </td>
                                <td style="text-align:right; font-weight:700; color:#FFF; background-color: #1e3c72  !important;">
                                ${monedaGrupo}$ ${subtotal.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </td>
                        </tr>
                    `;
                });

                // NOTA: Se eliminó el bloque "Total Página" como solicitaste.

                tbody.innerHTML = html;

                // Llamamos a calcular los totales globales cada vez que se actualiza la tabla
                // (Aunque los globales no cambian al paginar, esto asegura que se muestren)
                calcularTotalesGlobales();

            } else {
                tbody.innerHTML = `<tr><td colspan="9" class="empty-state">No hay datos</td></tr>`;
                document.getElementById('resumenMonedasContainer').style.display = 'none';
            }
        }

        // [NUEVA FUNCIÓN] Calcular totales globales por moneda
        function calcularTotalesGlobales() {
            const totalesPorMoneda = {};

            // Iteramos sobre TODOS los registros cargados (no solo la página actual)
            todosLosRegistros.forEach(r => {
                const moneda = r.moneda || r.Moneda || 'N/A';
                const monto = parseFloat(r.totalR || 0);

                if (!totalesPorMoneda[moneda]) {
                    totalesPorMoneda[moneda] = 0;
                }
                totalesPorMoneda[moneda] += monto;
            });

            // Generar HTML del resumen
            const container = document.getElementById('resumenMonedasContainer');
            let htmlResumen = '<h3>Totales Generales por Moneda</h3><div class="totales-grid">';

            for (const [moneda, total] of Object.entries(totalesPorMoneda)) {
                // Asignamos una clase diferente si es USD o RD para estilo (opcional)
                const claseMoneda = moneda.includes('US') ? 'total-usd' : 'total-rd';

                htmlResumen += `
                    <div class="total-card ${claseMoneda}">
                        <div class="total-label">Total ${moneda}</div>
                        <div class="total-value">${moneda} ${total.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                `;
            }
            htmlResumen += '</div>';

            container.innerHTML = htmlResumen;
            container.style.display = 'block';
        }
        // Actualizar resumen (ahora en el header)
        function actualizarResumen(data) {
            // Mostrar total de grupos, no registros
            document.getElementById('totalRegistros').textContent = gruposClientes.length;
            const totalMonto = Number(data.valorTotal || 0);
            document.getElementById('totalMonto').textContent = 'RD$ ' + totalMonto.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Imprimir reporte
        function imprimirReporte() {
            if (gruposClientes.length === 0) {
                alert('⚠️ No hay datos cargados para imprimir. Por favor, carga el reporte primero.');
                return;
            }

            const form = document.getElementById('filtrosForm');
            const formData = new FormData(form);

            document.getElementById('loadingSpinner').style.display = 'block';

            fetch('@Url.Action("GenerarPDF", "CuentasPorCobrar")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Error al generar el PDF');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ReporteCxC_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('❌ Error al generar el PDF: ' + error.message);
            });
        }

        // Exportar reporte
        function exportarReporte() {
            if (gruposClientes.length === 0) {
                alert('⚠️ No hay datos cargados para exportar. Por favor, carga el reporte primero.');
                return;
            }

            const form = document.getElementById('filtrosForm');
            const formData = new FormData(form);

            document.getElementById('loadingSpinner').style.display = 'block';

            fetch('@Url.Action("ExportarExcel", "CuentasPorCobrar")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Error al generar el archivo Excel');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ReporteCxC_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('❌ Error al exportar a Excel: ' + error.message);
            });
        }

        // Cargar datos al presionar Enter
        document.querySelectorAll('.filter-group input, .filter-group select').forEach(element => {
            element.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    generarReporte();
                }
            });
        });

                       // ===============================================
            //  LÓGICA MODAL RELACIÓN DE PAGOS
            // ===============================================
            function abrirModalRelacionPagos(clienteCodigo, clienteNombre) {
                if (!clienteCodigo || clienteCodigo === "undefined" || clienteCodigo === "") {
                    alert("⚠️ Error: No se pudo identificar el código del cliente para este grupo.");
                    console.error("Cliente Código es:", clienteCodigo);
                    return;
                }

                document.getElementById('modalRelacionPagos').style.display = 'flex';
                document.getElementById('tituloModalPagos').textContent = `Ingresos: ${clienteNombre}`;
                document.getElementById('loadingPagos').style.display = 'block';
                document.getElementById('contenidoPagos').style.display = 'none';
                document.body.style.overflow = 'hidden'; // Bloquear scroll

                // Nota: Debes crear este endpoint en tu controlador
                fetch(`@Url.Action("ObtenerRelacionPagos", "CuentasPorCobrar")?cliente=${encodeURIComponent(clienteCodigo)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderizarTablaPagos(data.pagos);
                        } else {
                            document.getElementById('tablaPagosBody').innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">${data.message || 'Error al cargar pagos'}</td></tr>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('tablaPagosBody').innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">Error de conexión</td></tr>`;
                    })
                    .finally(() => {
                        document.getElementById('loadingPagos').style.display = 'none';
                        document.getElementById('contenidoPagos').style.display = 'block';
                    });
            }

            function cerrarModalRelacionPagos() {
                document.getElementById('modalRelacionPagos').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            function renderizarTablaPagos(pagos) {
                const tbody = document.getElementById('tablaPagosBody');
                const tfoot = document.getElementById('tablaPagosFooter');

                if (!pagos || pagos.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">No hay historial de ingresos para este cliente.</td></tr>`;
                    tfoot.innerHTML = '';
                    return;
                }

                let html = '';
                let total = 0;

                pagos.forEach(p => {
                    const fecha = p.fecha ? new Date(p.fecha).toLocaleDateString('es-DO') : '';
                    const monto = parseFloat(p.monto || 0);
                    total += monto;

                    html += `
                        <tr>
                            <td>${fecha}</td>
                            <td>${p.documento || ''}</td>
                            <td>${p.observacion || ''}</td>
                            <td style="text-align:center;">${p.moneda || ''}</td>
                            <td class="monto-col">${monto.toLocaleString('es-DO', {minimumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                tfoot.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:right; font-weight:bold;">Total Pagado:</td>
                        <td class="monto-col" style="font-weight:bold; color:#27ae60;">
                            ${total.toLocaleString('es-DO', {minimumFractionDigits: 2})}
                        </td>
                    </tr>
                `;
            }

        // Modal: abrir usando endpoints de CxC
        function abrirModalFacturaCxC(contrato, cliente) {
            const modal = document.getElementById('modalFactura');
            document.body.style.overflow = 'hidden';

            modal.innerHTML = `
                <div class="modal-factura-content" style="display:flex;align-items:center;justify-content:center;height:200px;">
                    <div class="spinner"></div>
                </div>
            `;
            modal.classList.add('active');

            fetch(`/CuentasPorCobrar/CargarModalDetalleFactura?contrato=${encodeURIComponent(contrato)}&cliente=${encodeURIComponent(cliente)}`)
                .then(r => r.text())
                .then(html => {
                    modal.innerHTML = html;
                    fetch(`/CuentasPorCobrar/ObtenerDetalleFactura?contrato=${encodeURIComponent(contrato)}&cliente=${encodeURIComponent(cliente)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                poblarModalConDatos(data.data);
                            } else {
                                mostrarErrorModal(data.message || 'Error al cargar el detalle');
                            }
                        })
                        .catch(() => mostrarErrorModal('Error al conectar con el servidor'));
                })
                .catch(() => {
                    modal.innerHTML = `
                        <div class="modal-factura-content" style="padding:40px;text-align:center;">
                            <h3 style="color:#e74c3c;">⚠️ Error al cargar la vista</h3>
                            <p>No se pudo cargar el detalle del contrato.</p>
                            <div style="margin-top:20px;">
                                <button class="btn-modal btn-modal-secondary" onclick="cerrarModalFactura()">Cerrar</button>
                            </div>
                        </div>
                    `;
                });
        }

        // Inicializar paginación si hay datos al cargar
        window.addEventListener('load', function() {
            @if (Model?.Items != null && Model.Items.Count > 0)
            {
                    <text>
                    todosLosRegistros = @Html.Raw(Json.Serialize(Model.Items));
                    agruparPorCliente();
                    mostrarPagina(1);
                    </text>
            }
        });

            // ============ BÚSQUEDA DE CLIENTES OPTIMIZADA PARA CXC ============

    // Variables de búsqueda de clientes CxC
    let clientesDisponiblesCxC = [];
    let paginaClientesCxCActual = 1;
    let totalClientesCxCPaginas = 0;
    let filtroClienteCxCActual = "";
    let timeoutBusquedaCxC = null;

    // Modal Clientes CxC
    function abrirModalClientesCxC() {
        document.getElementById('modalClientesCxC').style.display = 'flex';
        document.getElementById('buscarClienteCxC').value = "";
        document.getElementById('buscarClienteCxC').focus();
        limpiarListaClientesCxC();
        paginaClientesCxCActual = 1;
    }

    function cerrarModalClientesCxC() {
        document.getElementById('modalClientesCxC').style.display = 'none';
        limpiarListaClientesCxC();
    }

    function limpiarListaClientesCxC() {
        document.getElementById('listaClientesCxC').innerHTML = 
            '<p style="text-align:center;color:#999;">Ingresa al menos 2 caracteres para buscar</p>';
        document.getElementById('paginacionClientesCxC').innerHTML = '';
    }

    // Búsqueda con debounce (500ms)
    function buscarClientesCxCDebounce(valor) {
        if (timeoutBusquedaCxC) {
            clearTimeout(timeoutBusquedaCxC);
        }

        if (valor.length < 2) {
            limpiarListaClientesCxC();
            return;
        }

        document.getElementById('listaClientesCxC').innerHTML = 
            '<p style="text-align:center;color:#999;">🔍 Buscando...</p>';

        timeoutBusquedaCxC = setTimeout(() => {
            cargarClientesCxC(valor, 1);
        }, 500);
    }

    // Buscar al presionar Enter
    function buscarClientesCxCEnter(event, valor) {
        if (event.key === 'Enter') {
            event.preventDefault();
            
            if (timeoutBusquedaCxC) {
                clearTimeout(timeoutBusquedaCxC);
            }

            if (valor.length < 2) {
                alert('⚠️ Ingresa al menos 2 caracteres para buscar');
                return;
            }

            document.getElementById('listaClientesCxC').innerHTML = 
                '<p style="text-align:center;color:#999;">🔍 Buscando...</p>';
            
            cargarClientesCxC(valor, 1);
        }
    }

    function cargarClientesCxC(filtro, pagina) {
        filtroClienteCxCActual = filtro;
        paginaClientesCxCActual = pagina;

        fetch(`@Url.Action("ObtenerClientes", "CuentasPorCobrar")?filtro=${encodeURIComponent(filtro)}&pagina=${pagina}&registrosPorPagina=15`)
            .then(response => response.json())
            .then(data => {
                clientesDisponiblesCxC = data.clientes || [];
                totalClientesCxCPaginas = data.totalPaginas || 0;

                if (clientesDisponiblesCxC.length > 0) {
                    mostrarClientesCxC(clientesDisponiblesCxC);
                    mostrarPaginacionClientesCxC(data.total, pagina, totalClientesCxCPaginas);
                } else {
                    document.getElementById('listaClientesCxC').innerHTML = 
                        `<p style="text-align:center;color:#999;">❌ ${data.mensaje || 'No se encontraron clientes'}</p>`;
                    document.getElementById('paginacionClientesCxC').innerHTML = '';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('listaClientesCxC').innerHTML = 
                    '<p style="text-align:center;color:#d32f2f;">⚠️ Error al buscar clientes</p>';
            });
    }

    function mostrarClientesCxC(clientes) {
        const lista = document.getElementById('listaClientesCxC');
        let html = '';
        
        clientes.forEach(cliente => {
            html += `<div class="cliente-item" onclick="seleccionarClienteCxC('${cliente.codigo.replace(/'/g, "\\'")}', '${cliente.nombre.replace(/'/g, "\\'")}')">
                <div class="cliente-codigo">${cliente.codigo}</div>
                <div class="cliente-nombre">${cliente.nombre}</div>
            </div>`;
        });
        
        lista.innerHTML = html;
    }

    function mostrarPaginacionClientesCxC(total, paginaActual, totalPaginas) {
        const contenedor = document.getElementById('paginacionClientesCxC');
        
        if (totalPaginas <= 1) {
            contenedor.innerHTML = '';
            return;
        }

        let html = `<div class="paginacion-clientes">
            <small>Página ${paginaActual} de ${totalPaginas} (${total} clientes)</small>
            <div class="paginacion-botones">`;

        if (paginaActual > 1) {
            html += `<button class="pag-btn" onclick="cargarClientesCxC('${filtroClienteCxCActual}', ${paginaActual - 1})">← Anterior</button>`;
        }

        for (let i = Math.max(1, paginaActual - 2); i <= Math.min(totalPaginas, paginaClientesCxCActual + 2); i++) {
            if (i === paginaActual) {
                html += `<button class="pag-btn active">${i}</button>`;
            } else {
                html += `<button class="pag-btn" onclick="cargarClientesCxC('${filtroClienteCxCActual}', ${i})">${i}</button>`;
            }
        }

        if (paginaActual < totalPaginas) {
            html += `<button class="pag-btn" onclick="cargarClientesCxC('${filtroClienteCxCActual}', ${paginaActual + 1})">Siguiente →</button>`;
        }

        html += `</div></div>`;
        contenedor.innerHTML = html;
    }

    function seleccionarClienteCxC(codigo, nombre) {
        document.getElementById('clienteInput').value = nombre;
        cerrarModalClientesCxC();
    }

    // Validación de fechas
    document.getElementById('fechaDesde').addEventListener('change', validarFechasCxC);
    document.getElementById('fechaHasta').addEventListener('change', validarFechasCxC);

    function validarFechasCxC() {
        const fechaDesde = new Date(document.getElementById('fechaDesde').value);
        const fechaHasta = new Date(document.getElementById('fechaHasta').value);
        const alerta = document.getElementById('alertaFechas');

        if (fechaDesde > fechaHasta && document.getElementById('fechaHasta').value) {
            alerta.style.display = 'block';
            return false;
        } else {
            alerta.style.display = 'none';
            return true;
        }
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('modalClientesCxC');
        if (event.target === modal) {
            cerrarModalClientesCxC();
        }
    }

            // --- Lógica Modal Vendedores ---
        function abrirModalVendedores() {
            document.getElementById('modalVendedores').style.display = 'flex';
        }

        function cerrarModalVendedores() {
            document.getElementById('modalVendedores').style.display = 'none';
        }

        function marcarTodosVendedores(estado) {
            const checks = document.querySelectorAll('.chk-vendedor');
            checks.forEach(chk => chk.checked = estado);
        }

        function aplicarFiltroVendedores() {
            const checks = document.querySelectorAll('.chk-vendedor:checked');
            const codigos = Array.from(checks).map(c => c.value);

            // Actualizar input oculto (para el backend)
            document.getElementById('vendedor').value = codigos.join(',');

            // Actualizar visualización
            const display = document.getElementById('vendedorDisplay');
            if (codigos.length === 0) {
                display.value = "";
                display.placeholder = "-- Todos --";
            } else if (codigos.length === 1) {
                display.value = codigos[0]; // Muestra el código si es solo uno
            } else {
                display.value = `${codigos.length} Vendedores seleccionados`;
            }

            cerrarModalVendedores();
        }

        // Ejecutar al cargar para mostrar el texto correcto si ya hay filtro aplicado
        window.addEventListener('load', function() {
            const valorActual = document.getElementById('vendedor').value;
            if (valorActual) {
                const cantidad = valorActual.split(',').length;
                const display = document.getElementById('vendedorDisplay');
                if (cantidad === 1) display.value = valorActual;
                else display.value = `${cantidad} Vendedores seleccionados`;
            }
        });
    </script>
    <!-- Contenedor del modal (reutilizado) -->
    <div id="modalFactura" class="modal-factura"></div>
    <script src="~/js/modal-factura.js"></script>
</body>