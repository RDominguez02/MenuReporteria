@model ResultadoCxC

@{
    ViewData["Title"] = "Reporte de Cuentas por Cobrar";
}

<link rel="stylesheet" href="~/css/cxc.css" />
<link rel="stylesheet" href="~/css/modal-factura.css" />

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relación Cuentas x Cobrar - Estado x Cliente</title>
</head>
<body>
    <div class="reporte-container">
        <!-- Header -->
        <div class="reporte-header">
            <div class="reporte-header-left">
                <div class="reporte-header-icon">📊</div>
                <h1>Relación Cuentas x Cobrar</h1>
            </div>

            <!-- Resumen en el Header -->
            <div class="header-summary">
                <div class="header-summary-item">
                    <div class="header-summary-label">Total Registros</div>
                    <div class="header-summary-value" id="totalRegistros">@(Model?.TotalFacturas ?? 0)</div>
                </div>
                <div class="header-summary-item">
                    <div class="header-summary-label">Total Monto</div>
                    <div class="header-summary-value" id="totalMonto">RD$ @((Model?.ValorTotal ?? 0).ToString("N2"))</div>
                </div>
            </div>

            <!-- Botones en el Header -->
            <div class="header-actions">
                <button type="button" class="btn-toggle-filters" onclick="toggleFiltros()">
                    <span id="toggleIcon">🔽</span> Desplegar filtros
                </button>
                <button type="button" class="btn-action btn-aceptar" onclick="generarReporte()">
                    ✓ Filtrar
                </button>
                <button type="button" class="btn-action btn-imprimir" onclick="imprimirReporte()">
                    🖨️ Imprimir
                </button>
                <button type="button" class="btn-action btn-exportar" onclick="exportarReporte()">
                    📥 Exportar
                </button>
                <button type="button" class="btn-action btn-retornar" onclick="window.location.href='@Url.Action("Index", "Home")'">
                    ← Retornar
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <form id="filtrosForm" class="filters-section" method="post" action="@Url.Action("Generar", "CuentasPorCobrar")">
            @Html.AntiForgeryToken()
            <div class="filters-title">Criterios de Búsqueda</div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="fechaDesde">Desde la Fecha de Corte</label>
                    <input type="date" id="fechaDesde" name="fechaDesde" value="@Model?.Filtros?.FechaDesde?.ToString("yyyy-MM-dd")">
                </div>
                <div class="filter-group">
                    <label for="fechaHasta">Hasta la Fecha De Corte</label>
                    <input type="date" id="fechaHasta" name="fechaHasta" value="@Model?.Filtros?.FechaHasta?.ToString("yyyy-MM-dd")">
                </div>
                <div class="filter-group">
                    <label for="zona">Para la Zona</label>
                    <select id="zona" name="zona">
                        <option value="">Seleccionar...</option>
                        @if (Model?.Filtros?.ZonasDisponibles != null)
                        {
                            foreach (var zona in Model.Filtros.ZonasDisponibles)
                            {
                                @* <option value="@zona.Valor" @(string.Equals(Model?.Filtros?.Zona, zona.Valor, System.StringComparison.OrdinalIgnoreCase) ? "selected" : null)>@zona.Texto</option> *@
                            }
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label for="cliente">Para el Cliente</label>
                    <select id="cliente" name="cliente">
                        <option value="">Seleccionar...</option>
                        @if (Model?.Filtros?.ClientesDisponibles != null)
                        {
                            foreach (var cliente in Model.Filtros.ClientesDisponibles)
                            {
                                @* <option value="@cliente.Valor" @(string.Equals(Model?.Filtros?.Cliente, cliente.Valor, System.StringComparison.OrdinalIgnoreCase) ? "selected" : null)>@cliente.Texto</option> *@
                            }
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label for="vendedor">Para el Vendedor</label>
                    <select id="vendedor" name="vendedor">
                        <option value="">Seleccionar...</option>
                        @if (Model?.Filtros?.VendedoresDisponibles != null)
                        {
                            foreach (var vendedor in Model.Filtros.VendedoresDisponibles)
                            {
                                @* <option value="@vendedor.Valor" @(string.Equals(Model?.Filtros?.Vendedor, vendedor.Valor, System.StringComparison.OrdinalIgnoreCase) ? "selected" : null)>@vendedor.Texto</option> *@
                            }
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label for="factura">Desde la Factura</label>
                    <input type="text" id="factura" name="factura" placeholder="Número de factura" value="@Model?.Filtros?.FacturaDesde">
                </div>
                <div class="filter-group">
                    <label for="facturaHasta">Hasta la Factura</label>
                    <input type="text" id="facturaHasta" name="facturaHasta" placeholder="Número de factura" value="@Model?.Filtros?.FacturaHasta">
                </div>
                <div class="filter-group">
                    <label for="cuotaDesde">Desde la Cuota</label>
                    <input type="number" id="cuotaDesde" name="cuotaDesde" placeholder="Número de cuota" value="@(Model?.Filtros?.CuotaDesde?.ToString() ?? string.Empty)">
                </div>
                <div class="filter-group">
                    <label for="cuotaHasta">Hasta la Cuota</label>
                    <input type="number" id="cuotaHasta" name="cuotaHasta" placeholder="Número de cuota" value="@(Model?.Filtros?.CuotaHasta?.ToString() ?? string.Empty)">
                </div>

                <div class="filter-group">
                    <label for="moneda">Para la Moneda</label>
                    <select id="moneda" name="moneda">
                        <option value="">Seleccionar...</option>
                        @if (Model?.Filtros?.MonedasDisponibles != null)
                        {
                            foreach (var moneda in Model.Filtros.MonedasDisponibles)
                            {
                                @* <option value="@moneda.Valor" @(string.Equals(Model?.Filtros?.Moneda, moneda.Valor, System.StringComparison.OrdinalIgnoreCase) ? "selected" : null)>@moneda.Texto</option> *@
                            }
                        }
                    </select>
                </div>

                <div class="report-type-group">
                    <h4>Orden de Moneda</h4>
                    <div class="report-type-options">
                        <label>
                            <input type="radio" name="ordenMoneda" value="opcion1" checked>
                            Orden de Moneda + Fecha + Factura
                        </label>
                        <label>
                            <input type="radio" name="ordenMoneda" value="opcion2">
                            Orden de Moneda + Facturas + Fecha
                        </label>
                    </div>
                </div>
            </div>
        </form>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Cargando datos...</p>
        </div>

        <!-- Paginación Superior -->
        <div class="pagination-container">
            <div class="pagination-info">
                <div class="records-per-page">
                    <label for="recordsPerPage">Registros por página:</label>
                    <select id="recordsPerPage" name="recordsPerPage" onchange="cambiarRegistrosPorPagina()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="pagination-text">
                    Mostrando <strong id="rangoInicio">0</strong> a <strong id="rangoFin">0</strong> de <strong id="totalRegistrosPagina">0</strong> registros
                </div>
            </div>
            <div class="pagination-controls" id="paginationControls">
                <!-- Los botones de paginación se generarán dinámicamente -->
            </div>
        </div>

        <!-- Tabla de Resultados -->
        <div id="tablaResultados" class="table-container">
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Nombre / Dirección</th>
                        <th>Fecha Factura</th>
                        <th>Factura</th>
                        <th>Fecha Cuota</th>
                        <th>Días Vencimiento</th>
                        <th>Nro Cuota</th>
                        <th>Moneda</th>
                        <th>Zona</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.Items != null && Model.Items.Count > 0)
                    {
                        @foreach (var CXC in Model.Items)
                        {
                            <tr>
                                <td>
                                    <div>@CXC.NombreCliente</div>
                                    <small>@CXC.Direccion</small>
                                </td>
                                <td>@CXC.FechaFactura.ToString("dd-MM-yyyy")</td>
                                <td>@CXC.Factura</td>
                                <td>@CXC.FechaFactura.ToString("dd-MM-yyyy")</td>
                                <td>@CXC.DiasVencimiento</td>
                                <td>@CXC.Cuota</td>
                                <td>@CXC.Moneda</td>
                                <td>@CXC.Zona</td>
                                <td style="text-align: right;">@CXC.TotalR.ToString("N2")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">📊</div>
                                <div class="empty-state-text">No hay datos para mostrar</div>
                                <small>Ajusta los filtros y haz clic en "Filtrar" para cargar los datos</small>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Paginación Inferior -->
        <div class="pagination-container">
            <div class="pagination-info">
                <div class="pagination-text">
                    Página <strong id="paginaActualInfo">1</strong> de <strong id="totalPaginasInfo">1</strong>
                </div>
            </div>
            <div class="pagination-controls" id="paginationControlsBottom">
                <!-- Los botones de paginación se generarán dinámicamente -->
            </div>
        </div>
    </div>

    <script>
        // Variables de paginación
        let todosLosRegistros = [];
        let paginaActual = 1;
        let registrosPorPagina = 25;

        // Toggle filtros
        function toggleFiltros() {
            const filtros = document.getElementById('filtrosForm');
            const icon = document.getElementById('toggleIcon');

            if (filtros.classList.contains('hidden')) {
                filtros.classList.remove('hidden');
                icon.textContent = '🔽';
            } else {
                filtros.classList.add('hidden');
                icon.textContent = '▶️';
            }
        }

        // Generar reporte
        function generarReporte() {
            const form = document.getElementById('filtrosForm');
            const formData = new FormData(form);

            // Ocultar filtros después de generar
            const filtros = document.getElementById('filtrosForm');
            const icon = document.getElementById('toggleIcon');
            filtros.classList.add('hidden');
            icon.textContent = '▶️';

            // Reiniciar paginación
            paginaActual = 1;

            // Mostrar spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('tablaResultados').style.display = 'none';

            // Enviar formulario
            fetch('@Url.Action("Generar", "CuentasPorCobrar")', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Guardar todos los registros
                    todosLosRegistros = data.data.cuentas || [];
                    actualizarResumen(data);
                    mostrarPagina(1);
                } else {
                    alert('Error: ' + data.message);
                }

                // Ocultar spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('tablaResultados').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los datos');
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('tablaResultados').style.display = 'block';
            });
        }

        // Cambiar registros por página
        function cambiarRegistrosPorPagina() {
            registrosPorPagina = parseInt(document.getElementById('recordsPerPage').value);
            paginaActual = 1;
            mostrarPagina(1);
        }

        // Mostrar página específica
        function mostrarPagina(pagina) {
            paginaActual = pagina;

            const inicio = (pagina - 1) * registrosPorPagina;
            const fin = inicio + registrosPorPagina;
            const registrosPagina = todosLosRegistros.slice(inicio, fin);

            actualizarTabla(registrosPagina);
            actualizarInfoPaginacion(inicio, fin);
            generarBotonesPaginacion();
        }

        // Actualizar información de paginación
        function actualizarInfoPaginacion(inicio, fin) {
            const total = todosLosRegistros.length;
            document.getElementById('rangoInicio').textContent = total > 0 ? inicio + 1 : 0;
            document.getElementById('rangoFin').textContent = Math.min(fin, total);
            document.getElementById('totalRegistrosPagina').textContent = total;

            const totalPaginas = Math.ceil(total / registrosPorPagina);
            document.getElementById('paginaActualInfo').textContent = paginaActual;
            document.getElementById('totalPaginasInfo').textContent = totalPaginas || 1;
        }

        // Generar botones de paginación
        function generarBotonesPaginacion() {
            const totalPaginas = Math.ceil(todosLosRegistros.length / registrosPorPagina);
            const contenedorTop = document.getElementById('paginationControls');
            const contenedorBottom = document.getElementById('paginationControlsBottom');

            let html = '';

            // Botón anterior
            html += `<button class="pagination-btn" onclick="mostrarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>
                ← Anterior
            </button>`;

            // Lógica para mostrar números de página
            const maxBotones = 5;
            let inicioPagina = Math.max(1, paginaActual - 2);
            let finPagina = Math.min(totalPaginas, inicioPagina + maxBotones - 1);

            if (finPagina - inicioPagina < maxBotones - 1) {
                inicioPagina = Math.max(1, finPagina - maxBotones + 1);
            }

            // Primera página
            if (inicioPagina > 1) {
                html += `<button class="pagination-btn" onclick="mostrarPagina(1)">1</button>`;
                if (inicioPagina > 2) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            // Páginas numeradas
            for (let i = inicioPagina; i <= finPagina; i++) {
                html += `<button class="pagination-btn ${i === paginaActual ? 'active' : ''}" onclick="mostrarPagina(${i})">${i}</button>`;
            }

            // Última página
            if (finPagina < totalPaginas) {
                if (finPagina < totalPaginas - 1) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="mostrarPagina(${totalPaginas})">${totalPaginas}</button>`;
            }

            // Botón siguiente
            html += `<button class="pagination-btn" onclick="mostrarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas || totalPaginas === 0 ? 'disabled' : ''}>
                Siguiente →
            </button>`;

            contenedorTop.innerHTML = html;
            contenedorBottom.innerHTML = html;
        }

        // Actualizar tabla con datos
        function actualizarTabla(registros) {
            const tbody = document.querySelector('.results-table tbody');

            if (registros && registros.length > 0) {
                // Ordenar por nombre y fecha para estabilidad visual
                const ordenados = [...registros].sort((a, b) => {
                    const na = (a.nombreCliente || '').localeCompare(b.nombreCliente || '', 'es-DO');
                    if (na !== 0) return na;
                    const fa = a.fechaFactura ? new Date(a.fechaFactura).getTime() : 0;
                    const fb = b.fechaFactura ? new Date(b.fechaFactura).getTime() : 0;
                    return fa - fb;
                });

                // Agrupar por nombreCliente
                const grupos = {};
                for (const r of ordenados) {
                    const key = r.nombreCliente || '(Sin nombre)';
                    if (!grupos[key]) grupos[key] = [];
                    grupos[key].push(r);
                }

                let html = '';
                Object.keys(grupos).forEach(nombre => {
                    const items = grupos[nombre];
                    const direccion = items.find(x => x.direccion)?.direccion || '';

                    // Encabezado de grupo
                    html += `
                        <tr class="group-header">
                            <td colspan="9" style="background:#f4f6f8;font-weight:600;">
                                ${nombre} ${direccion ? ` - <small>${direccion}</small>` : ''}
                            </td>
                        </tr>
                    `;

                    // Filas del grupo
                    let subtotal = 0;
                    items.forEach(registro => {
                        const fecha = registro.fechaFactura ? new Date(registro.fechaFactura) : null;
                        const fechaFormateada = fecha ? fecha.toLocaleDateString('es-DO') : '';
                        const balance = parseFloat(registro.totalR || 0);
                        subtotal += isNaN(balance) ? 0 : balance;

                        html += `
                            <tr>
                                <td>
                                    <button class="btn-ver-factura" onclick="abrirModalFacturaCxC('${registro.factura}', '${registro.codigoCliente || ''}')">👁️ Ver</button>
                                </td>
                                <td>${fechaFormateada}</td>
                                <td>${registro.factura || ''}</td>
                                <td>${fechaFormateada}</td>
                                <td>${registro.diasVencimiento ?? 0}</td>
                                <td>${registro.cuota || ''}</td>
                                <td>${registro.moneda || ''}</td>
                                <td>${registro.zona || ''}</td>
                                <td style="text-align: right;">${(balance).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            </tr>
                        `;
                    });

                    // Subtotal del grupo
                    html += `
                        <tr class="group-subtotal">
                            <td colspan="8" style="text-align:right;font-weight:700;">Subtotal ${nombre}</td>
                            <td style="text-align:right;font-weight:700;">
                                ${subtotal.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <div class="empty-state-text">No se encontraron resultados</div>
                            <small>Intenta ajustar los filtros de búsqueda</small>
                        </td>
                    </tr>
                `;
            }
        }

        // Actualizar resumen (ahora en el header)
        function actualizarResumen(data) {
            document.getElementById('totalRegistros').textContent = data.totalFacturas || 0;
            const totalMonto = Number(data.valorTotal || 0);
            document.getElementById('totalMonto').textContent = 'RD$ ' + totalMonto.toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // Imprimir reporte
        function imprimirReporte() {
            if (todosLosRegistros.length === 0) {
                alert('⚠️ No hay datos cargados para imprimir. Por favor, carga el reporte primero.');
                return;
            }

            const form = document.getElementById('filtrosForm');
            const formData = new FormData(form);

            document.getElementById('loadingSpinner').style.display = 'block';

            fetch('@Url.Action("GenerarPDF", "CuentasPorCobrar")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Error al generar el PDF');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ReporteCxC_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('❌ Error al generar el PDF: ' + error.message);
            });
        }

        // Exportar reporte
        function exportarReporte() {
            if (todosLosRegistros.length === 0) {
                alert('⚠️ No hay datos cargados para exportar. Por favor, carga el reporte primero.');
                return;
            }

            const form = document.getElementById('filtrosForm');
            const formData = new FormData(form);

            document.getElementById('loadingSpinner').style.display = 'block';

            fetch('@Url.Action("ExportarExcel", "CuentasPorCobrar")', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error('Error al generar el archivo Excel');
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ReporteCxC_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('❌ Error al exportar a Excel: ' + error.message);
            });
        }

        // Cargar datos al presionar Enter
        document.querySelectorAll('.filter-group input, .filter-group select').forEach(element => {
            element.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    generarReporte();
                }
            });
        });

        // Modal: abrir usando endpoints de CxC reutilizando el mismo partial y JS
        function abrirModalFacturaCxC(contrato, cliente) {
            const modal = document.getElementById('modalFactura');
            document.body.style.overflow = 'hidden';

            modal.innerHTML = `
                <div class="modal-factura-content" style="display:flex;align-items:center;justify-content:center;height:200px;">
                    <div class="spinner"></div>
                </div>
            `;
            modal.classList.add('active');

            fetch(`/CuentasPorCobrar/CargarModalDetalleFactura?contrato=${encodeURIComponent(contrato)}&cliente=${encodeURIComponent(cliente)}`)
                .then(r => r.text())
                .then(html => {
                    modal.innerHTML = html;
                    // Cargar datos reales para el modal
                    fetch(`/CuentasPorCobrar/ObtenerDetalleFactura?contrato=${encodeURIComponent(contrato)}&cliente=${encodeURIComponent(cliente)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                poblarModalConDatos(data.data);
                            } else {
                                mostrarErrorModal(data.message || 'Error al cargar el detalle');
                            }
                        })
                        .catch(() => mostrarErrorModal('Error al conectar con el servidor'));
                })
                .catch(() => {
                    modal.innerHTML = `
                        <div class="modal-factura-content" style="padding:40px;text-align:center;">
                            <h3 style="color:#e74c3c;">⚠️ Error al cargar la vista</h3>
                            <p>No se pudo cargar el detalle del contrato.</p>
                            <div style="margin-top:20px;">
                                <button class="btn-modal btn-modal-secondary" onclick="cerrarModalFactura()">Cerrar</button>
                            </div>
                        </div>
                    `;
                });
        }

        // Inicializar paginación si hay datos al cargar
        @if (Model?.Items != null && Model.Items.Count > 0)
        {
                <text>
                        todosLosRegistros = @Html.Raw(Json.Serialize(Model.Items));
                mostrarPagina(1);
                </text>
        }
    </script>
    <!-- Contenedor del modal (reutilizado) -->
    <div id="modalFactura" class="modal-factura"></div>
    <script src="~/js/modal-factura.js"></script>
</body>